<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OpenClaw Manager</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" media="print" onload="this.media='all'">
<noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"></noscript>
<!--SERVER_STATE-->
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Inter', -apple-system, sans-serif;
    background: #fafafa;
    color: #71717a;
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .container {
    width: 100%;
    max-width: 520px;
    padding: 48px 40px;
    background: #fff;
    border: 1.5px solid #e4e4e7;
    border-radius: 20px;
    box-shadow: 0 4px 24px rgba(0,0,0,0.06);
  }

  .brand {
    text-align: center;
    margin-bottom: 40px;
  }
  .brand-name {
    font-size: 38px;
    font-weight: 800;
    letter-spacing: -1.5px;
    color: #09090b;
    line-height: 1;
  }
  .brand-sub {
    font-size: 14px;
    color: #a1a1aa;
    margin-top: 12px;
    font-weight: 400;
    letter-spacing: 4px;
    text-transform: uppercase;
  }

  .panel { display: none; }
  .panel.active { display: block; }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .panel.active { animation: fadeIn 0.3s ease; }

  /* Profile cards */
  .profile-card {
    padding: 18px 20px;
    background: #fafafa;
    border: 1px solid #f0f0f2;
    border-radius: 14px;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .profile-info {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .profile-dot {
    width: 10px; height: 10px;
    border-radius: 50%;
  }
  .profile-dot.running { background: #22c55e; }
  .profile-dot.stopped { background: #ef4444; }
  .profile-name {
    font-size: 16px;
    font-weight: 600;
    color: #09090b;
  }
  .profile-port {
    font-size: 13px;
    color: #a1a1aa;
    margin-left: 4px;
  }

  .empty-state {
    text-align: center;
    padding: 32px 0;
    color: #a1a1aa;
    font-size: 15px;
  }

  /* Buttons */
  button {
    width: 100%;
    padding: 16px;
    background: #09090b;
    color: #fff;
    border: none;
    border-radius: 10px;
    font-size: 15px;
    font-weight: 700;
    font-family: 'Inter', sans-serif;
    letter-spacing: 0.5px;
    cursor: pointer;
    transition: all 0.2s ease;
    margin-top: 16px;
    box-shadow: 0 2px 8px rgba(9,9,11,0.18);
  }
  button:hover {
    background: #27272a;
    transform: translateY(-1px);
    box-shadow: 0 4px 14px rgba(9,9,11,0.22);
  }
  button:active { transform: translateY(0); }
  button:disabled {
    background: #e4e4e7;
    color: #a1a1aa;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }
  button.sm {
    padding: 8px 16px;
    font-size: 13px;
    margin-top: 0;
    width: auto;
  }
  button.danger { background: #ef4444; }
  button.danger:hover { background: #dc2626; }

  /* Fields */
  .field {
    margin-bottom: 24px;
    padding: 18px;
    background: #fafafa;
    border: 1px solid #f0f0f2;
    border-radius: 14px;
  }

  label {
    display: block;
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 2px;
    color: #09090b;
    margin-bottom: 10px;
  }

  input, select {
    width: 100%;
    padding: 14px 16px;
    background: #f9f9fb;
    border: 1.5px solid #e4e4e7;
    border-radius: 10px;
    color: #09090b;
    font-size: 16px;
    font-family: 'Inter', sans-serif;
    font-weight: 400;
    outline: none;
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
    -webkit-appearance: none;
  }
  input:focus, select:focus {
    border-color: #09090b;
    box-shadow: 0 0 0 3px rgba(9,9,11,0.08);
    background: #fff;
  }
  input::placeholder { color: #d4d4d8; }

  .field-hint {
    font-size: 13px;
    color: #a1a1aa;
    margin-top: 10px;
  }
  .field-hint a {
    color: #09090b;
    text-decoration: underline;
    text-underline-offset: 3px;
    text-decoration-thickness: 1.5px;
    font-weight: 600;
  }

  /* Steps indicator */
  .back-link {
    display: inline-block;
    font-size: 14px;
    color: #a1a1aa;
    cursor: pointer;
    margin-bottom: 24px;
    font-weight: 500;
  }
  .back-link:hover { color: #09090b; }

  .steps {
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 32px;
  }
  .step-num {
    width: 36px; height: 36px;
    border-radius: 50%;
    border: 2px solid #e4e4e7;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 13px;
    font-weight: 600;
    color: #a1a1aa;
    transition: all 0.4s ease;
  }
  .step-num.active { border-color: #09090b; color: #09090b; }
  .step-num.done { border-color: #09090b; background: #09090b; color: #fff; }
  .step-line { width: 60px; height: 2px; background: #e4e4e7; transition: background 0.4s ease; }
  .step-line.done { background: #09090b; }

  /* Progress bar */
  .progress-wrap {
    margin-top: 28px;
    display: none;
  }
  .progress-wrap.active { display: block; }
  .progress-bar-bg {
    width: 100%;
    height: 8px;
    background: #f0f0f2;
    border-radius: 4px;
    overflow: hidden;
  }
  .progress-bar-fill {
    height: 100%;
    width: 0%;
    background: #09090b;
    border-radius: 4px;
    transition: width 0.6s ease;
  }
  .progress-bar-fill.error { background: #ef4444; }
  .progress-msg {
    font-size: 13px;
    color: #71717a;
    margin-top: 10px;
    min-height: 18px;
    animation: breathe 2.5s ease-in-out infinite;
  }
  @keyframes breathe {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.35; }
  }
  .progress-pct {
    font-size: 13px;
    font-weight: 600;
    color: #09090b;
    margin-top: 6px;
  }
</style>
</head>
<body>

<div class="container">
  <div class="brand">
    <div class="brand-name">OpenClaw Manager</div>
    <div class="brand-sub">Powered by EvoLink</div>
  </div>

  <!-- Home: profile list -->
  <div class="panel" id="home">
    <div id="profileList"></div>
    <button type="button" id="addBtn">+ New Instance</button>
  </div>

  <!-- Step 1: Instance config -->
  <div class="panel" id="step1">
    <span class="back-link" id="backHome">&larr; Back</span>
    <div class="steps">
      <div class="step-num active">1</div>
      <div class="step-line"></div>
      <div class="step-num">2</div>
      <div class="step-line"></div>
      <div class="step-num">3</div>
    </div>
    <form id="step1Form">
      <div class="field">
        <label>Instance Name</label>
        <input type="text" id="profileName" placeholder="default" autocomplete="off">
        <div class="field-hint">Unique name for this instance</div>
      </div>
      <div class="field">
        <label>Model</label>
        <select id="modelSelect"></select>
      </div>
      <div class="field">
        <label>Channel</label>
        <select id="channelSelect">
          <option value="telegram">Telegram</option>
          <option value="feishu">Feishu</option>
        </select>
      </div>
      <button type="submit">Next</button>
    </form>
  </div>

  <!-- Step 2: Deploy -->
  <div class="panel" id="step2">
    <div class="steps">
      <div class="step-num done">&#10003;</div>
      <div class="step-line done"></div>
      <div class="step-num active">2</div>
      <div class="step-line"></div>
      <div class="step-num">3</div>
    </div>
    <form id="step2Form">
      <div class="field">
        <label>EvoLink API Key</label>
        <input type="password" id="apiKey" placeholder="sk-..." required autocomplete="off">
        <div class="field-hint">Get your key at <a href="https://evolink.ai" target="_blank">evolink.ai</a></div>
      </div>
      <div class="field" id="telegramTokenField">
        <label>Telegram Bot Token</label>
        <input type="text" id="botToken" placeholder="123456789:ABCdef..." autocomplete="off">
        <div class="field-hint">Create a bot via <a href="https://t.me/BotFather" target="_blank">@BotFather</a></div>
      </div>
      <div class="field" id="feishuAppIdField" style="display:none">
        <label>Feishu App ID</label>
        <input type="text" id="feishuAppId" placeholder="cli_xxx" autocomplete="off">
        <div class="field-hint">From <a href="https://open.feishu.cn/app" target="_blank">Feishu Open Platform</a></div>
      </div>
      <div class="field" id="feishuAppSecretField" style="display:none">
        <label>Feishu App Secret</label>
        <input type="password" id="feishuAppSecret" placeholder="App Secret" autocomplete="off">
      </div>
      <button type="submit" id="deployBtn">Deploy</button>
    </form>
    <div class="progress-wrap" id="deployProgress">
      <div class="progress-bar-bg"><div class="progress-bar-fill" id="deployFill"></div></div>
      <div class="progress-pct" id="deployPct"></div>
      <div class="progress-msg" id="deployMsg"></div>
    </div>
  </div>

  <!-- Step 3: Connect -->
  <div class="panel" id="step3">
    <div class="steps">
      <div class="step-num done">&#10003;</div>
      <div class="step-line done"></div>
      <div class="step-num done">&#10003;</div>
      <div class="step-line done"></div>
      <div class="step-num active">3</div>
    </div>
    <form id="step3Form">
      <div class="field" id="telegramIdField">
        <label>Your Telegram User ID</label>
        <input type="text" id="telegramId" placeholder="123456789" autocomplete="off">
        <div class="field-hint">Send /start to <a href="https://t.me/userinfobot" target="_blank">@userinfobot</a> to get your ID</div>
      </div>
      <div id="feishuDoneField" style="display:none;text-align:center;padding:24px 0;color:#09090b;font-size:15px;line-height:1.8;">
        Deploy complete.<br>
        Go to <a href="https://open.feishu.cn/app" target="_blank" style="color:#09090b;font-weight:600;text-decoration:underline">Feishu Open Platform</a> &rarr; Event Subscriptions &rarr; select "Receive events via WebSocket" &rarr; click Save.<br>
        Then send a message to the bot to start chatting.
      </div>
      <button type="submit" id="connectBtn">Connect</button>
      <button type="button" id="skipBtn" class="outline" style="display:none">Done</button>
    </form>
    <div class="progress-wrap" id="connectProgress">
      <div class="progress-bar-bg"><div class="progress-bar-fill" id="connectFill"></div></div>
      <div class="progress-pct" id="connectPct"></div>
      <div class="progress-msg" id="connectMsg"></div>
    </div>
  </div>
</div>

<script>
var STATE = window.__STATE__ || { profiles: [], models: [] };
var currentProfile = "default";
var currentChannel = "telegram";
var currentModel = "";

function $(id) { return document.getElementById(id); }

function esc(s) {
  var d = document.createElement("div");
  d.textContent = s;
  return d.innerHTML;
}

function showPanel(id) {
  var panels = document.querySelectorAll(".panel");
  for (var i = 0; i < panels.length; i++) panels[i].classList.remove("active");
  $(id).classList.add("active");
}

// Populate model dropdown
function initModels() {
  var sel = $("modelSelect");
  sel.innerHTML = "";
  var models = STATE.models || [];
  for (var i = 0; i < models.length; i++) {
    var opt = document.createElement("option");
    opt.value = models[i].id;
    opt.textContent = models[i].name;
    sel.appendChild(opt);
  }
  if (models.length > 0) sel.value = models[models.length - 1].id;
}

function renderProfiles(profiles) {
  var list = $("profileList");
  if (!profiles || profiles.length === 0) {
    list.innerHTML = '<div class="empty-state">No instances yet. Click below to create one.</div>';
    return;
  }
  var html = "";
  for (var i = 0; i < profiles.length; i++) {
    var p = profiles[i];
    var running = p.gateway === "running";
    var safeName = esc(p.profile);
    var attrName = esc(p.profile).replace(/'/g, "&#39;");
    html += '<div class="profile-card">';
    html += '<div class="profile-info">';
    html += '<span class="profile-dot ' + (running ? "running" : "stopped") + '"></span>';
    html += '<div>';
    html += '<span class="profile-name">' + safeName + '</span>';
    html += '<span class="profile-port">:' + p.port + '</span>';
    html += '<div style="font-size:12px;color:#a1a1aa;margin-top:4px">';
    if (p.model) html += esc(p.model);
    html += ' <span style="cursor:pointer;color:#09090b;font-size:14px;margin-left:4px;vertical-align:middle" title="Change model" onclick="openModelModal(\'' + attrName + '\',\'' + esc(p.modelId || '') + '\')">\u270E</span>';
    if (p.model && p.channel) html += ' \u00b7 ';
    if (p.channel) html += esc(p.channel);
    html += '</div>';
    html += '</div>';
    html += '</div>';
    html += '<div class="profile-actions">';
    if (running) {
      html += '<button class="sm danger" onclick="doStop(\'' + attrName + '\',this)">Stop</button>';
    } else {
      html += '<button class="sm" onclick="doStart(\'' + attrName + '\',this)">Start</button>';
    }
    html += ' <button class="sm danger" onclick="doDelete(\'' + attrName + '\',this)" style="margin-left:6px">Delete</button>';
    html += '</div>';
    html += '</div>';
  }
  list.innerHTML = html;
}

function refreshProfiles(cb) {
  var xhr = new XMLHttpRequest();
  xhr.open("GET", "/profiles");
  xhr.onload = function() {
    if (xhr.status === 200) {
      var profiles = JSON.parse(xhr.responseText);
      STATE.profiles = profiles;
      renderProfiles(profiles);
    }
    if (cb) cb();
  };
  xhr.onerror = function() { if (cb) cb(); };
  xhr.send();
}

function doStart(profile, btn) {
  btn.disabled = true;
  btn.textContent = "Starting...";
  var xhr = new XMLHttpRequest();
  xhr.open("POST", "/start-gateway");
  xhr.setRequestHeader("Content-Type", "application/json");
  xhr.onload = function() {
    if (xhr.status !== 200) {
      try { alert("Start failed: " + JSON.parse(xhr.responseText).error); } catch(e) { alert("Start failed"); }
    }
    setTimeout(function() { refreshProfiles(); }, 2000);
  };
  xhr.onerror = function() { alert("Network error"); refreshProfiles(); };
  xhr.send(JSON.stringify({ profile: profile }));
}

function doStop(profile, btn) {
  btn.disabled = true;
  btn.textContent = "Stopping...";
  var xhr = new XMLHttpRequest();
  xhr.open("POST", "/stop-gateway");
  xhr.setRequestHeader("Content-Type", "application/json");
  xhr.onload = function() {
    if (xhr.status !== 200) {
      try { alert("Stop failed: " + JSON.parse(xhr.responseText).error); } catch(e) { alert("Stop failed"); }
    }
    setTimeout(function() { refreshProfiles(); }, 2000);
  };
  xhr.onerror = function() { alert("Network error"); refreshProfiles(); };
  xhr.send(JSON.stringify({ profile: profile }));
}

function doDelete(profile, btn) {
  if (!confirm("Delete instance \"" + profile + "\"? This will stop the gateway and remove all configuration.")) return;
  btn.disabled = true;
  btn.textContent = "Deleting...";
  var xhr = new XMLHttpRequest();
  xhr.open("POST", "/delete-profile");
  xhr.setRequestHeader("Content-Type", "application/json");
  xhr.onload = function() {
    if (xhr.status !== 200) {
      try { alert("Delete failed: " + JSON.parse(xhr.responseText).error); } catch(e) { alert("Delete failed"); }
    }
    refreshProfiles();
  };
  xhr.onerror = function() { alert("Network error"); refreshProfiles(); };
  xhr.send(JSON.stringify({ profile: profile }));
}

function openModelModal(profile, currentModelId) {
  // Remove existing modal if any
  var old = document.getElementById("modelModal");
  if (old) old.remove();

  var models = STATE.models || [];
  var overlay = document.createElement("div");
  overlay.id = "modelModal";
  overlay.style.cssText = "position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.35);display:flex;align-items:center;justify-content:center;z-index:9999;animation:fadeIn 0.2s ease";

  var box = document.createElement("div");
  box.style.cssText = "background:#fff;border-radius:16px;padding:28px 24px;width:320px;max-width:90vw;box-shadow:0 8px 32px rgba(0,0,0,0.15)";

  var title = document.createElement("div");
  title.style.cssText = "font-size:16px;font-weight:700;color:#09090b;margin-bottom:18px;text-align:center";
  title.textContent = "Switch Model";
  box.appendChild(title);

  var list = document.createElement("div");
  for (var i = 0; i < models.length; i++) {
    (function(m) {
      var item = document.createElement("div");
      var isCurrent = m.id === currentModelId;
      item.style.cssText = "padding:12px 16px;border-radius:10px;margin-bottom:6px;cursor:pointer;font-size:14px;font-weight:500;transition:all 0.15s ease;"
        + (isCurrent ? "background:#09090b;color:#fff;" : "background:#fafafa;color:#09090b;border:1px solid #f0f0f2;");
      item.textContent = m.name;
      if (isCurrent) {
        item.textContent = m.name + "  \u2713";
        item.style.cursor = "default";
      }
      item.onmouseenter = function() { if (!isCurrent) item.style.background = "#f0f0f2"; };
      item.onmouseleave = function() { if (!isCurrent) item.style.background = "#fafafa"; };
      item.onclick = function() {
        if (isCurrent) return;
        // Disable all items, show loading
        var items = list.querySelectorAll("div");
        for (var k = 0; k < items.length; k++) {
          items[k].style.pointerEvents = "none";
          items[k].style.opacity = "0.5";
        }
        item.style.opacity = "1";
        item.textContent = m.name + "  ...";
        item.style.background = "#09090b";
        item.style.color = "#fff";

        var xhr = new XMLHttpRequest();
        xhr.open("POST", "/change-model");
        xhr.setRequestHeader("Content-Type", "application/json");
        xhr.onload = function() {
          if (xhr.status !== 200) {
            try { alert("Change model failed: " + JSON.parse(xhr.responseText).error); } catch(e) { alert("Change model failed"); }
          }
          overlay.remove();
          refreshProfiles();
        };
        xhr.onerror = function() { alert("Network error"); overlay.remove(); refreshProfiles(); };
        xhr.send(JSON.stringify({ profile: profile, modelId: m.id }));
      };
      list.appendChild(item);
    })(models[i]);
  }
  box.appendChild(list);

  var cancelBtn = document.createElement("div");
  cancelBtn.style.cssText = "text-align:center;margin-top:14px;font-size:13px;color:#a1a1aa;cursor:pointer;font-weight:500";
  cancelBtn.textContent = "Cancel";
  cancelBtn.onmouseenter = function() { cancelBtn.style.color = "#09090b"; };
  cancelBtn.onmouseleave = function() { cancelBtn.style.color = "#a1a1aa"; };
  cancelBtn.onclick = function() { overlay.remove(); };
  box.appendChild(cancelBtn);

  overlay.appendChild(box);
  overlay.onclick = function(e) { if (e.target === overlay) overlay.remove(); };
  document.body.appendChild(overlay);
}

// Init
initModels();
renderProfiles(STATE.profiles);
showPanel("home");

// Auto-refresh every 3s when home is visible
var pollTimer = null;
function startPolling() {
  stopPolling();
  pollTimer = setInterval(function() {
    if ($("home").classList.contains("active")) refreshProfiles();
  }, 3000);
}
function stopPolling() {
  if (pollTimer) { clearInterval(pollTimer); pollTimer = null; }
}
startPolling();

// --- Navigation ---
$("addBtn").addEventListener("click", function() {
  $("profileName").value = "";
  showPanel("step1");
});

$("backHome").addEventListener("click", function() {
  refreshProfiles(function() { showPanel("home"); });
});

// --- Step 1: Next ---
$("step1Form").addEventListener("submit", function(e) {
  e.preventDefault();
  currentProfile = $("profileName").value.trim() || "default";

  // Validate profile name
  if (currentProfile !== "default") {
    if (currentProfile.length > 32) {
      alert("Instance name too long (max 32 characters).");
      return;
    }
    if (!/^[a-zA-Z0-9_-]+$/.test(currentProfile)) {
      alert("Instance name can only contain letters, numbers, hyphens and underscores.");
      return;
    }
  }

  currentModel = $("modelSelect").value;
  currentChannel = $("channelSelect").value;

  // Check if profile already exists
  var existing = STATE.profiles || [];
  for (var i = 0; i < existing.length; i++) {
    if (existing[i].profile === currentProfile) {
      alert("Instance \"" + currentProfile + "\" already exists. Choose a different name.");
      return;
    }
  }

  // Reset step 2
  $("apiKey").value = "";
  $("botToken").value = "";
  $("deployBtn").disabled = false;
  $("deployProgress").classList.remove("active");
  $("deployFill").style.width = "0%";
  $("deployFill").classList.remove("error");
  $("deployPct").textContent = "";
  $("deployMsg").textContent = "";
  $("step2Form").style.display = "";

  // Show/hide channel-specific fields
  $("telegramTokenField").style.display = currentChannel === "telegram" ? "" : "none";
  $("feishuAppIdField").style.display = currentChannel === "feishu" ? "" : "none";
  $("feishuAppSecretField").style.display = currentChannel === "feishu" ? "" : "none";

  showPanel("step2");
});

// --- Step 2: Deploy with SSE progress ---
$("step2Form").addEventListener("submit", function(e) {
  e.preventDefault();
  var apiKey = $("apiKey").value.trim();
  var botToken = $("botToken").value.trim();
  var appId = $("feishuAppId").value.trim();
  var appSecret = $("feishuAppSecret").value.trim();

  if (!apiKey) return;
  if (currentChannel === "telegram" && !botToken) return;
  if (currentChannel === "feishu" && (!appId || !appSecret)) return;

  $("deployBtn").disabled = true;
  $("deployProgress").classList.add("active");
  $("deployFill").style.width = "0%";
  $("deployFill").classList.remove("error");
  $("deployPct").textContent = "0%";
  $("deployMsg").textContent = "Starting...";

  var params = "profile=" + encodeURIComponent(currentProfile)
    + "&apiKey=" + encodeURIComponent(apiKey)
    + "&model=" + encodeURIComponent(currentModel)
    + "&channel=" + encodeURIComponent(currentChannel);

  if (currentChannel === "telegram") {
    params += "&botToken=" + encodeURIComponent(botToken);
  } else if (currentChannel === "feishu") {
    params += "&appId=" + encodeURIComponent(appId);
    params += "&appSecret=" + encodeURIComponent(appSecret);
  }

  var es = new EventSource("/setup-stream?" + params);
  es.onmessage = function(ev) {
    var d = JSON.parse(ev.data);
    if (d.error) {
      $("deployFill").style.width = "100%";
      $("deployFill").classList.add("error");
      $("deployPct").textContent = "Error";
      $("deployMsg").textContent = d.message;
      $("deployBtn").disabled = false;
      es.close();
      return;
    }
    $("deployFill").style.width = d.percent + "%";
    $("deployPct").textContent = d.percent + "%";
    $("deployMsg").textContent = d.message;
    if (d.done) {
      es.close();
      $("step2Form").style.display = "none";
      setTimeout(function() {
        // Reset step 3
        $("telegramId").value = "";
        $("connectBtn").disabled = false;
        $("connectProgress").classList.remove("active");
        $("connectFill").style.width = "0%";
        $("connectFill").classList.remove("error");
        $("connectPct").textContent = "";
        $("connectMsg").textContent = "";
        $("step3Form").style.display = "";

        $("telegramIdField").style.display = currentChannel === "telegram" ? "" : "none";
        $("feishuDoneField").style.display = currentChannel === "feishu" ? "" : "none";
        $("connectBtn").style.display = currentChannel === "telegram" ? "" : "none";
        $("skipBtn").style.display = currentChannel === "feishu" ? "" : "none";
        showPanel("step3");
      }, 800);
    }
  };
  es.onerror = function() {
    $("deployFill").style.width = "100%";
    $("deployFill").classList.add("error");
    $("deployPct").textContent = "Error";
    $("deployMsg").textContent = "Connection lost";
    $("deployBtn").disabled = false;
    es.close();
  };
});

// --- Step 3: Done (restart gateway to apply config cleanly) ---
$("skipBtn").addEventListener("click", function() {
  $("skipBtn").disabled = true;
  $("skipBtn").textContent = "Restarting...";
  fetch("/restart-gateway", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ profile: currentProfile })
  }).finally(function() {
    $("skipBtn").disabled = false;
    $("skipBtn").textContent = "Done";
    refreshProfiles(function() { showPanel("home"); });
  });
});

// --- Step 3: Connect with SSE progress ---
$("step3Form").addEventListener("submit", function(e) {
  e.preventDefault();
  var telegramId = $("telegramId").value.trim();

  if (currentChannel === "telegram" && !telegramId) return;

  $("connectBtn").disabled = true;
  $("connectProgress").classList.add("active");
  $("connectFill").style.width = "0%";
  $("connectFill").classList.remove("error");
  $("connectPct").textContent = "0%";
  $("connectMsg").textContent = "Starting...";

  var params = "profile=" + encodeURIComponent(currentProfile)
    + "&channel=" + encodeURIComponent(currentChannel);

  if (currentChannel === "telegram") {
    params += "&telegramId=" + encodeURIComponent(telegramId);
  }

  var es = new EventSource("/connect-stream?" + params);
  es.onmessage = function(ev) {
    var d = JSON.parse(ev.data);
    if (d.error) {
      $("connectFill").style.width = "100%";
      $("connectFill").classList.add("error");
      $("connectPct").textContent = "Error";
      $("connectMsg").textContent = d.message;
      $("connectBtn").disabled = false;
      es.close();
      return;
    }
    $("connectFill").style.width = d.percent + "%";
    $("connectPct").textContent = d.percent + "%";
    $("connectMsg").textContent = d.message;
    if (d.done) {
      es.close();
      $("step3Form").style.display = "none";
      setTimeout(function() {
        refreshProfiles(function() { showPanel("home"); });
      }, 1200);
    }
  };
  es.onerror = function() {
    $("connectFill").style.width = "100%";
    $("connectFill").classList.add("error");
    $("connectPct").textContent = "Error";
    $("connectMsg").textContent = "Connection lost";
    $("connectBtn").disabled = false;
    es.close();
  };
});
</script>
</body>
</html>
